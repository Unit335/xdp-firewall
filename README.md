# XDP Firewall
## Описание
ПО состоит из трёх программ: BPF-XDP модуля xdp_prog, xb-loader, который выполняет загрузку модуля в ядро и xb-stats, который отображает статистику с количеством заблокированных пакетов.

### xb-loader 
xb-loader выполняет загрузку, отключение и обновление фильтров BPF-программы. Для запуска используются следующие аргументы:
```
 -d, --dev <interface>      указывает интерфейс/устройство для работы
 -h, --help                 отображает справку
 -S, --skb-mode             SKB/generic режим загрузки
 -N, --native-mode          native режим загрузки 
 -F, --force                заменяет существующую программу
 -U, --unload               отключает существущую программу
 -W, --update-filters       обновляет фильтры на основе файла xdp.conf
```

Для загрузки BPF-программы необходимо указать режим загрузки (-S или -N и интерфейс -d), например:
```
./xb-loader -S -d enp0s3
```
Для отключения BPF-программы необходимо указать флаг -U, режим загрузки (-S или -N и интерфейс -d), например:
```
./xb-loader -U -S -d enp0s3
```
Для обновления фильтров флаг -W и интерфейс -d:
```
./xb-loader -W -d enp0s3
```
### xb-stats
xb-stats отображает количество заблокированных на интерфейсе пакетов. Синтаксис:
```
./xb-stats -d <interface>
```

## Конфигурация
Описание фильтров хранится в файле xdp.conf в следующем формате:
```sh
filters = (
    {
        #фильтр 1
    	enabled = true, 
    	udp_enabled = true,
        udp_dport = 44934
    },
    {
        #фильтр 2
        enabled = true,
        srcip = "8.8.8.8"
    }
);
```
Фильтрация производится только при полном соответствии параметров пакета одному из фильтров, для их настройки используются следующие параметры:
```
srcip               ip адрес источника (формат "1.1.1.1")
dstip               ip адрес назначения (формат "1.1.1.1")
udp_enabled         блокировка UDP пакетов (true/false)
udp_sport           порт адреса источника UDP пакета
udp_dport           порт адреса назначения UDP пакета
tcp_enabled         блокировка TCP пакетов (true/false)
tcp_sport           порт адреса ичтоника TCP пакета
tcp_dport           порт адреса назначения TCP пакета
icmp_enabled        блокировка ICMP пакетов (true/false)
```
udp_enabled, tcp_enabled и icmp_enabled - взаимоисключающие параметры, каждый фильтр может описывать только один формат пакетов. Для фильтрации по TCP/UDP портам необходимо также указать tcp_enabled или udp_enabled.
Например:
```
{
    #блокируе любые TCP пакеты
    enabled = true,
    tcp_enabled = true
},
{
    #блокирует UDP пакеты с портом назначения 5050
    enabled = true,
    udp_enabled = true,
    udp_dport = 5050
}
```
## Сборка и запуск

Необходимые для компиляции зависимости:
```sh
sudo apt-get install build-essential libconfig-dev llvm clang libelf-dev gcc-multilib libbpf-dev
```

Для сборки
```sh
git clone https://github.com/Unit335/xdp-firewall.git
cd xdp-firewall
make
```

Утилиты и файл конфигурации будут расположены в папке build/
Например, по умолчанию конфигурация блокирует все ICMP пакеты: 
```sh
cd build/
sudo ./xb-loader -S -d enp0s3 
ping 1.1.1.1
```
По итогу выполнянения ping результатом должна быть 100% потеря ответных пакетов.
Количество заблокированных пакетов можно посмотреть с помощью:
```
sudo ./xb-stats -d enp0s3
```

Можно также изменить конфигурационный файл, заменив icmp_enabled на tcp_enabled и обновив фильтры:
```sh
sudo ./xb-loader -W -d enp0s3 
echo 1 | netcat example.com 80 #отправка TCP пакета, не вернет ничего
ping 1.1.1.1 #будет работать корректно
```
Для отключения программы:
```sh
sudo ./xb-loader -U -S -d enp0s3
```
